{% extends "base.html" %}
{% block content %}

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">

  <div class="mb-6">
    <h1 class="text-2xl font-bold text-tec mb-2">Materias</h1>
    <p class="text-sm text-charade-500 mb-4">
      Selecciona filtros para visualizar materias (Nivel educativo, Grado/Nivel sugerido y, si aplica, Carrera).
    </p>
  </div>

  <!-- FILTROS -->
  <div class="bg-white rounded-xl shadow-sm border border-charade-200 p-6 mb-8">
    <form method="get" class="grid grid-cols-1 md:grid-cols-3 gap-6">

      <!-- NIVEL EDUCATIVO -->
      <div>
        <label for="id_nivel" class="block text-sm font-medium text-charade-900 mb-1">Nivel educativo</label>
        <select id="id_nivel" name="id_nivel"
          class="block w-full rounded-lg border-charade-300 bg-charade-50 p-2.5 text-sm focus:border-mitec-blue-light focus:ring-mitec-blue-light transition-shadow">
          <option value="">-- Selecciona --</option>
          {% for n in niveles %}
            <option value="{{ n.id_nivel }}" {% if filtros.id_nivel|stringformat:"s" == n.id_nivel|stringformat:"s" %}selected{% endif %}>
              {{ n.nombre }}
            </option>
          {% endfor %}
        </select>
      </div>

      <!-- GRADO / NIVEL SUGERIDO -->
      <div>
        <label for="grado" class="block text-sm font-medium text-charade-900 mb-1">Nivel sugerido / Grado</label>
        <input type="number" id="grado" name="grado" min="1"
          value="{{ filtros.grado }}"
          placeholder="Ej. 1, 2, 3..."
          class="block w-full rounded-lg border-charade-300 bg-charade-50 p-2.5 text-sm focus:border-mitec-blue-light focus:ring-mitec-blue-light transition-shadow placeholder-charade-400">
      </div>

      <!-- CARRERA -->
      <div>
        <label for="id_carrera" class="block text-sm font-medium text-charade-900 mb-1">Carrera (Prepa/Universidad)</label>
        <select id="id_carrera" name="id_carrera" disabled
          class="block w-full rounded-lg border-charade-300 bg-charade-50 p-2.5 text-sm focus:border-mitec-blue-light focus:ring-mitec-blue-light transition-shadow disabled:opacity-50">
          <option value="">-- Selecciona --</option>
          {% for c in carreras %}
            <option value="{{ c.id_carrera }}" {% if filtros.id_carrera|stringformat:"s" == c.id_carrera|stringformat:"s" %}selected{% endif %}>
              {{ c.nombre }}
            </option>
          {% endfor %}
        </select>
        <p class="text-xs text-charade-400 mt-1">Se habilita solo para Preparatoria y Universidad.</p>
      </div>

      <div class="md:col-span-3 flex flex-wrap gap-3">
        <button type="submit"
          class="inline-flex items-center justify-center rounded-lg bg-mitec-blue-primary px-4 py-2 text-sm font-semibold text-white hover:opacity-95 transition">
          Aplicar filtros
        </button>

        <a href="{% url 'academico:materia_list' %}"
          class="inline-flex items-center justify-center rounded-lg border border-charade-300 bg-white px-4 py-2 text-sm font-semibold text-charade-700 hover:bg-charade-50 transition">
          Limpiar
        </a>
      </div>
    </form>
  </div>

  <!-- RESULTADOS -->
  {% if not hay_filtros %}
    <div class="bg-white rounded-xl shadow-sm border border-charade-200 p-6">
      <p class="text-sm text-charade-500">
        Aun no hay filtros seleccionados. Elige al menos uno para mostrar materias.
      </p>
    </div>
  {% else %}
    <div class="bg-white rounded-xl shadow-sm border border-charade-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-charade-100">
          <thead class="bg-charade-50">
            <tr>
              <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-charade-500 uppercase tracking-wider">Clave</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-charade-500 uppercase tracking-wider">Nombre</th>
              <th scope="col" class="px-6 py-4 text-center text-xs font-semibold text-charade-500 uppercase tracking-wider">Creditos</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-charade-500 uppercase tracking-wider">Nivel</th>
              <th scope="col" class="px-6 py-4 text-center text-xs font-semibold text-charade-500 uppercase tracking-wider">Sugerido</th>
              <th scope="col" class="px-6 py-4 text-left text-xs font-semibold text-charade-500 uppercase tracking-wider">Carrera</th>
              <th scope="col" class="px-6 py-4 text-center text-xs font-semibold text-charade-500 uppercase tracking-wider">Sesiones</th>
              <th scope="col" class="px-6 py-4 text-center text-xs font-semibold text-charade-500 uppercase tracking-wider">Acciones</th>
            </tr>
          </thead>

          <tbody class="bg-white divide-y divide-charade-100">
            {% for m in materias %}
              <tr class="hover:bg-charade-50 transition-colors duration-150">
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-mitec-blue-primary">{{ m.clave }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-charade-900 font-medium">{{ m.nombre }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-charade-600">{{ m.creditos }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-charade-600">{{ m.nivel_educativo.nombre }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-charade-900">{{ m.nivel_sugerido|default:"-" }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-charade-500 text-xs uppercase">
                  {% if m.carrera %}{{ m.carrera.nombre }}{% else %}-{% endif %}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-center text-charade-900">{{ m.sesiones_por_semana }}</td>
                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                  <div class="flex items-center justify-center gap-2">
                    <a href="{% url 'academico:materia_update' m.pk %}"
                      class="text-mitec-blue-primary bg-mitec-blue-primary/10 hover:bg-mitec-blue-primary hover:text-white p-2 rounded-lg transition">
                      Editar
                    </a>
                  </div>
                </td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="8" class="px-6 py-8 text-center text-sm text-charade-500">
                  No se encontraron materias con los filtros seleccionados.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  {% endif %}

</div>

<script>
  (function () {
    const nivelSelect = document.getElementById("id_nivel");
    const carreraSelect = document.getElementById("id_carrera");

    function normalizar(txt) {
      return (txt || "").trim().toLowerCase();
    }

    function carreraDebeHabilitarse() {
      const opt = nivelSelect.options[nivelSelect.selectedIndex];
      const nombre = normalizar(opt ? opt.text : "");
      const esPrepa = nombre.includes("prepa") || nombre.includes("preparatoria");
      const esUni = nombre.includes("univers") || nombre.includes("licencia");
      return esPrepa || esUni;
    }

    function toggleCarrera() {
      const habilitar = carreraDebeHabilitarse();
      carreraSelect.disabled = !habilitar;
      if (!habilitar) {
        carreraSelect.value = "";
      }
    }

    nivelSelect.addEventListener("change", toggleCarrera);
    toggleCarrera();
  })();
</script>

{% endblock %}
